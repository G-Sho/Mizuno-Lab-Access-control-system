# Slack OAuth の `authed_user` が空になるケース

Slack の OAuth v2 フローから返される `authed_user` フィールドは、常に同じ形で値が入っているわけではありません。以下のケースではユーザー ID やユーザーアクセストークンが省略され、バックエンドで `authed_user?.id` や `authed_user?.access_token` を参照しても `undefined` になります。

## `authed_user.id` が入らないケース

- **アプリ単位でインストール（Slack 管理画面 → アプリを追加）**
  - ワークスペース管理者が Slack の管理画面からアプリをインストールする場合、認可画面は表示されず、誰が操作したかを示すコンテキストが Slack 側に渡りません。そのため `oauth.v2.access` の応答にはインストールを実施したユーザー情報が含まれず、`authed_user` 自体が欠落するか、`id` が空になります。

## `authed_user.access_token` が入らないケース

- **ユーザースコープを 1 つも要求していない場合**
  - リクエスト URL に `user_scope` パラメーターを付けずに OAuth を開始すると、Slack はユーザーアクセストークンを発行しません。結果として `authed_user.access_token` がレスポンスに含まれないため、個別ユーザーとして API を叩くことができません。
- **ユーザーが権限を拒否した状態から管理者が強制インストールした場合**
  - ユーザーが認可画面で権限を拒否したあとに管理者が「許可」を選ぶと、bot トークンのみが発行されユーザートークンは生成されません。

## まとめ

このように、Slack 側が「どのユーザーとして認証したか」を特定できない状況や、ユーザースコープを含めないインストールフローでは `authed_user` の一部が省略されます。その場合、バックエンドはユーザー状態の更新をスキップして安全側に倒す必要があります。
